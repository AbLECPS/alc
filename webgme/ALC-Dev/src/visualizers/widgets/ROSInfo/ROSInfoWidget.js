/*globals define, WebGMEGlobal*/
/*jshint browser: true*/

/**
 * Generated by VisualizerGenerator 1.7.0 from webgme on Thu Jul 07 2016 11:24:16 GMT-0500 (Central Daylight Time).
 */

define(['js/Dialogs/CodeEditor/CodeEditorDialog',
	    'css!./styles/ROSInfoWidget.css',
		'../library/bootstrap3-editable-1.5.1/bootstrap3-editable/js/bootstrap-editable.min',
		'css!../library/bootstrap3-editable-1.5.1/bootstrap3-editable/css/bootstrap-editable.css'], 
		function (CodeEditorDialog) {
    'use strict';

    var ROSInfoWidget,
        WIDGET_CLASS = 'ros-viz';

    ROSInfoWidget = function (logger, container) {
        this._logger = logger.fork('Widget');

        this._el = container;

        this.nodes = {};
        this._initialize();
				

		this.rosNodes = {};
		this.rosNodeID = {};
		this.rosNodePortNames = {};
		this.rosNodePortNameToID = {};
		this.rosNodeKeys = [];
		this.rosTableTitles = {};
		this.rosTables = {};
		this.rosTablesID = {};
		this.rosTableCounter  = 0;

		this.messageInfo = {};
		this.messageNamesToID = {};
		this.messageNames = [];

		this.typelist = ['Publisher','Subscriber','Service Server','Service Client', 'Action Client', 'Action Server','Other']
		
		

		this.table = undefined;
        this._logger.debug('ctor finished');
    };

    ROSInfoWidget.prototype._initialize = function () {
        var width = this._el.width(),
            height = this._el.height(),
            self = this;

		$.fn.editable.defaults.mode = 'inline';
        // set widget class
        this._el.addClass(WIDGET_CLASS);
	
		var dummy = document.createElement('div');
		dummy.id='dummyheader';
		dummy.setAttribute("style", "margin-top: 50px;margin-left: 50px");
		this._el.append(dummy);

	};
	
	ROSInfoWidget.prototype.addInfo = function (desc) {
		var self = this;
		if (desc.metaName == 'Block')
		{
			self.addROSNodeInfo(desc);
		}
		if ((desc.metaName == "MessageType")||(desc.metaName == "ActionType")||(desc.metaName == "ServiceType"))
		{
			self.addMessageInfo(desc);
		}
	};
    
    ROSInfoWidget.prototype.addROSNodeInfo = function (desc) {
		var self = this;
		if (desc.ports)
		{

			var k = Object.keys(desc.ports);
			if ((k.length > 0) && (desc.phname.length > 0) )
			{
				self.rosNodes[desc.id] = desc;
				self.rosNodeID[desc.phname]= desc.id;
				self.rosNodePortNames[desc.id]=[];
				self.rosNodePortNameToID[desc.id]={}
				var portids = Object.keys(desc.ports);
				var i=0;
				for(i=0; i!=portids.length; i+=1)
				{
					var portid = portids[i];
					self.rosNodePortNames[desc.id].push(desc.ports[portid]['name']);
					self.rosNodePortNameToID[desc.id][desc.ports[portid]['name']] = portid;
					
				}
				self.rosNodePortNames[desc.id].sort()
				
			}
		}

		
	};
	
	ROSInfoWidget.prototype.addMessageInfo = function (desc) {
		var self = this;
		if (desc.messageInfo)
		{

			var id = desc.messageInfo['id'];
			self.messageInfo[id] = desc.messageInfo;
			//self._logger.debug('added messageinfo '+id)
		}

		
	};
	
	ROSInfoWidget.prototype.getMessageDisplayName = function (mid) {
		var self = this;
		var ret = '';
		if (mid in self.messageInfo)
		{
			return self.getMessageStr(self.messageInfo[mid])
		}

		return ret;

	};

	ROSInfoWidget.prototype.getMessageStr = function (msgInfo){
		var type = msgInfo['type'];
		var pname = msgInfo['package'];
		var mname  =  msgInfo['messagename'];
		var m = 'M :';

		if (type == 'ActionType')
		{
			m = 'A :';
		}
		else if (type == 'ServiceType')
		{
			m = 'S :';
		}

		m += pname + '/';
		m += mname;
		
		return m;
	
	};

	ROSInfoWidget.prototype.buildMessageStrs = function (){

		var self = this;
		var keys = Object.keys(self.messageInfo);
		var k = 0;

		for(k=0; k!=keys.length; k+=1)
		{
			var msgid = keys[k];
			var msgstr = self.getMessageStr(self.messageInfo[msgid]);
			self.messageNamesToID[msgstr]= msgid;
			self.messageNames.push(msgstr);
			self.messageInfo[msgid]['msgstr']=msgstr;
		}
		self.messageNames.sort();

	
	};

	
	ROSInfoWidget.prototype.getTypeModes = function(){
		var self = this;

		var modelist = [];
		var i= 0;
		
		
		for(i=0; i!=self.typelist.length; i+=1)
		{
			modelist.push({value: i+1, text: self.typelist[i]});
		}

		return modelist;
	};
	

	ROSInfoWidget.prototype.getTypeValues = function(val){
		var self = this;

		var idx = self.typelist.indexOf(val) +1;
		
		return idx;
	};


	ROSInfoWidget.prototype.getMessageModes = function(){
		var self = this;

		var modelist = [];
		var i= 0;
		
		modelist.push({value: 1, text: '--NONE--'});
		for(i=0; i!=self.messageNames.length; i+=1)
		{
			modelist.push({value: i+2, text: self.messageNames[i]});
		}

		return modelist;
	};
	

	ROSInfoWidget.prototype.getMessageValues = function(val){
		var self = this;

		if (val == '' || self.messageNames.indexOf(val) ==-1)
		{
			return 1;
		}

		var idx = self.messageNames.indexOf(val) +2;
				
		return idx;
	};

	ROSInfoWidget.prototype.getMessageID = function(idx){
		var self = this;
		var index = parseInt(idx);

		if (index==1)
		{
			return '';
		}
		
		return self.messageNamesToID[self.messageNames[index-2]];
		
	};
	
    
    
    ROSInfoWidget.prototype.renderTable = function () {
		var self = this;
		self.rosNodeKeys = Object.keys (self.rosNodeID);
		if (self.rosNodeKeys.length==0)
			return;
	
	
		self.rosNodeKeys.sort();
		self.buildMessageStrs();
		
	
		/*var nodeh = document.createElement('div');
		var chldh = document.createTextNode("ROS Node Interfaces");
		nodeh.appendChild(chldh);
		nodeh.setAttribute("style", "margin-top: 20px;margin-left: 50px; font-weight:bold");
		self._el.append(nodeh);*/

		var i =0;
		for(i=0; i!= self.rosNodeKeys.length; i +=1)
		{
			var nodename = self.rosNodeKeys[i];
			var nodeid  =  self.rosNodeID[nodename];
			self.renderROSNodeTable(nodeid, nodename);
		}

		    
	};
	
	
	ROSInfoWidget.prototype.renderROSNodeTable = function (blkid, blkname) {
		var self = this;
		
		var nodeh = document.createElement('div');
		var titleText = 'ROS Interfaces in : '+blkname;
		if (self.rosNodes[blkid].nodetype != 'Node')
		{
			titleText = self.rosNodes[blkid].nodetype + ' in : '+blkname;
		}
		//var chldh = document.createTextNode('ROS Node Interfaces in : '+blkname);
		//nodeh.appendChild(chldh);
    nodeh.className = 'ros-fake-link';
		nodeh.innerHTML = titleText;
		nodeh.setAttribute("style", "margin-top: 50px;margin-left: 50px; font-weight:bold");
		nodeh.style.font = "bold 20px arial,serif";
		nodeh.setAttribute("display", "block");
		var titleid = 'ros-table-title'+self.rosTableCounter.toString();
		nodeh.id=titleid;
		self._el.append(nodeh);
		self.rosTableTitles[blkid] = document.getElementById(titleid);//this._el.find('#'+titleid);

		
		var table = document.createElement('div');
		table.className = 'ros-viz-table'
		var tableid = 'ros-table-'+self.rosTableCounter.toString();
		table.id = tableid;
		table.id1 = blkid;
		//table.ondblclick = self.updateTable.bind(self,pid);
		
		table.setAttribute("style", "margin-top: 10px;margin-left: 50px");

		self._el.append(table);

		self.rosTables[blkid] = document.getElementById(tableid);
		self.rosTablesID[blkid]=this._el.find('#'+tableid);
		self.populateROSTable(blkid);
		self.rosTableCounter +=1;

		nodeh.onclick = self.onNodeClick.bind(self, blkid);
			
		
		
	};

	

	ROSInfoWidget.prototype.populateROSTable = function (blkid) {
		var self = this;
		var  i =0;
		var portnames  =  self.rosNodePortNames[blkid];
		var portids =  self.rosNodePortNameToID[blkid];
		var ports = self.rosNodes[blkid].ports;
		var keys = portnames;
		var chld = '';
		var mtext ='';

		var show_issues = false;
		for (i=0; i!= keys.length; i+=1)
		{
			var key = keys[i];
			var pid = portids[key];
			var pinfo = ports[pid];
			var issues = pinfo['issues'];
			if (issues)
			{
				show_issues = true;
				break;
			}
			var inftopic = pinfo['inftopic'];
			if (inftopic != '' && inftopic != topic)
			{
				show_issues = true;
				break;
			}

		}
		
		

		var node = document.createElement('div');
		node.className = 'ros-viz-heading';

		
		var cnode = document.createElement('div');
		cnode.className = 'ros-viz-table-type-col';
		var chld1 = document.createTextNode("Port Name ");
		cnode.appendChild(chld1);
		node.appendChild(cnode);

		cnode = document.createElement('div');
		cnode.className = 'ros-viz-table-type-col';
		var chld1 = document.createTextNode("Type");
		cnode.appendChild(chld1);
		node.appendChild(cnode);


		cnode = document.createElement('div');
		cnode.className = 'ros-viz-table-col';
		var chld1 = document.createTextNode("Message Type");
		cnode.appendChild(chld1);
		node.appendChild(cnode);

		cnode = document.createElement('div');
		cnode.className = 'ros-viz-table-col';
		var chld1 = document.createTextNode("Topic");
		cnode.appendChild(chld1);
		node.appendChild(cnode);

		if (show_issues)
		{
			cnode = document.createElement('div');
			cnode.className = 'ros-viz-table-col-issues';
			var chld1 = document.createTextNode("Concerns");
			cnode.appendChild(chld1);
			node.appendChild(cnode);
		}


		self.rosTablesID[blkid].append(node);
		
		
		var info = {};

		

		for (i=0; i!= keys.length; i+=1)
		{
			var key = keys[i];
			var pid = portids[key];
			var pinfo = ports[pid];
			var topic = pinfo['topic'];
			var type = pinfo['type'];
			var mid = pinfo['mid'];
			var issues = pinfo['issues'];
			var inftopic = pinfo['inftopic'];
			var inftopic_str = ''
			var issues_str =''
			if (show_issues)
			{
				if (inftopic && inftopic != '' && inftopic != topic)
				{
					inftopic_str = inftopic.replace(/\n/g, '<br><br>')
					issues_str = 'Inferred Topic: '+inftopic_str + '<br><br>'
				}
				if (issues)
				{
					issues = issues.replace(/\n/g, '<br><br>')
					issues_str += issues
				}
				if (issues_str == '')
				{
					issues_str = '-';
				}
			
			}
			var mname = '';
			if (mid)
			{
				mname = self.getMessageDisplayName(mid);
			}

			info[i]={'topic':topic,'type':type,'mname':mname};

			
			node = document.createElement('div');
			node.className = 'ros-viz-table-row';
			node.setAttribute("style", "background-color:#eee");
			
			chld = document.createElement('div');
			chld.className = 'ros-viz-table-type-col';
			var name = key;
			var chld1 = document.createTextNode(name);
			chld.id1 = pid;
			
			chld.appendChild(chld1);
			node.appendChild(chld);
			
			chld = document.createElement('div');
			chld.className = 'ros-viz-table-type-col';
			chld.id = 'type-'+self.rosTableCounter.toString()+'-'+i.toString();
			chld.id1 = pid;
			chld.id2 = 'type';
			mtext = type;
			chld.innerHTML = '<a href="#">' + mtext + '</a>';
			node.appendChild(chld);

			chld = document.createElement('div');
			chld.className = 'ros-viz-table-col';
			chld.id = 'message-'+self.rosTableCounter.toString()+'-'+i.toString();
			chld.id1 = pid;
			chld.id2 = 'message';
			mtext = mname;
			chld.innerHTML = '<a href="#">' + mtext + '</a>';
			node.appendChild(chld);

			chld = document.createElement('div');
			chld.className = 'ros-viz-table-col';
			chld.id = 'topic-'+self.rosTableCounter.toString()+'-'+i.toString();
			chld.id1 = pid;
			chld.id2 = 'topic';
			mtext = topic;
			chld.innerHTML = '<a href="#">' + mtext + '</a>';
			node.appendChild(chld);
			self.rosTablesID[blkid].append(node);

			if (show_issues)
			{
				chld = document.createElement('div');
				chld.className = 'ros-viz-table-col-issues';
				chld.id = 'issues-'+self.rosTableCounter.toString()+'-'+i.toString();
				chld.id1 = pid;
				chld.id2 = 'issues';
				mtext = issues_str;
				//chld.innerHTML = '<a href="#">' + mtext + '</a>';
				chld.innerHTML = mtext;
				//var chld1 = document.createTextNode(mtext);
				//chld.appendChild(chld1);
				node.appendChild(chld);
				self.rosTablesID[blkid].append(node);
			}
		}

		//type
		for (i=0; i!= keys.length; i+=1)
		{
			var typevalue = self.getTypeValues(info[i]['type']);
			var typemodes = self.getTypeModes();

			$('#type-' +self.rosTableCounter.toString()+'-'+i.toString()).editable({
				type: 'select',
				title: 'Select',
				autotext: 'always',
				emptytext: 'None',
				value: typevalue,
				source: typemodes,
				success: function (response, newValue) {
					self._logger.debug("new mode value = " + newValue + response);
					self._logger.debug("new mode value = " + this.innerText);
					var idx = parseInt(newValue);
					self.onEditTypeInfo(this.id1, self.typelist[idx-1], idx-1);
					
				}
			});

		}

		//message type
		for (i=0; i!= keys.length; i+=1)
		{
			var mesvalue = self.getMessageValues(info[i]['mname']);
			var mesmodes = self.getMessageModes();

			$('#message-' +self.rosTableCounter.toString()+'-'+i.toString()).editable({
				type: 'select',
				title: 'Select',
				autotext: 'always',
				emptytext: 'None',
				value: mesvalue,
				source: mesmodes,
				success: function (response, newValue) {
					self._logger.debug("new mode value = " + newValue + response);
					self._logger.debug("new mode value = " + this.innerText);
					var minfo = self.getMessageID(newValue);
					self.onEditMessageInfo(this.id1, minfo);
				}
			});
		}

		//topic
		for (i=0; i!= keys.length; i+=1)
		{
			var topicvalue = info[i]['topic'];

			$('#topic-' +self.rosTableCounter.toString()+'-'+i.toString()).editable({
				type: 'text',
				title: 'Topic',
				autotext: 'always',
				emptytext: 'None',
				value: topicvalue,
				success: function (response, newValue) {
					self._logger.debug("new mode value = " + newValue + response);
					self._logger.debug("new mode value = " + this.innerText);
					self.onEditTopicInfo(this.id1, newValue);
					
				}
			});

		}


	};

	

    ROSInfoWidget.prototype.onWidgetContainerResize = function (width, height) {
        // this._logger.debug('Widget is resizing...');
    };

    // Adding/Removing/Updating items
    ROSInfoWidget.prototype.addNode = function (desc) {
		var self = this;
        if (desc) {
	    
			if (desc.use ==1) {
				// Add node to a table of nodes
				self.addInfo(desc);
				
				
			}
			if (desc.last ==1)
				self.renderTable();
	    
            
        }
	
    };

    ROSInfoWidget.prototype.removeNode = function (gmeId) {
        var desc = this.nodes[gmeId];
	if (desc)
	{
		//this._el.append('<div>Removing node "' + desc.name + '"</div>');
		delete this.nodes[gmeId];
	}
    };

    ROSInfoWidget.prototype.updateNode = function (desc) {
		var self = this;
        if (desc) {
			this._logger.debug('Updating node:', desc);
			
            //this._el.append('<div>Updating node "' + desc.name + '"</div>');
        }
    };

    /* * * * * * * * Visualizer event handlers * * * * * * * */

    ROSInfoWidget.prototype.onNodeClick = function (/*id*/) {
        // This currently changes the active node to the given id and
        // this is overridden in the controller.
    };
    
     ROSInfoWidget.prototype.onEditModeInfo = function (/*id*/) {
        // This currently changes the active node to the given id and
        // this is overridden in the controller.
    }

    ROSInfoWidget.prototype.onBackgroundDblClick = function () {
        this._el.append('<div>Background was double-clicked!!</div>');
    };

    /* * * * * * * * Visualizer life cycle callbacks * * * * * * * */
    ROSInfoWidget.prototype.destroy = function () {
    };

    ROSInfoWidget.prototype.onActivate = function () {
        this._logger.debug('ROSInfoWidget has been activated');
    };

    ROSInfoWidget.prototype.onDeactivate = function () {
        this._logger.debug('ROSInfoWidget has been deactivated');
    };

    return ROSInfoWidget;
});
